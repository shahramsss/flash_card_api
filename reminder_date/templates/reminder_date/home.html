{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
  <div dir="rtl" class="row align-items-center mb-4">
    <div class="col-md-6 text-end">
      <h4 class="mb-0">ğŸ“ŒÛŒØ§Ø¯Ø¢ÙˆØ±</h4>
    </div>
    <div class="col-md-6 text-start">
      <a class="btn btn-success" href="{% url 'reminder:reminder_create' %}">Ø«Ø¨Øª ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ</a>
    </div>
  </div>

  <!-- ØªØ§Ø±ÛŒØ® Ø§Ù…Ø±ÙˆØ² Ø´Ù…Ø³ÛŒ -->
  <div dir="rtl" class="card shadow-sm mb-4">
    <div class="card-body text-end">
      <h6 class="card-title text-secondary mb-3">ğŸ“… ØªØ§Ø±ÛŒØ® Ø§Ù…Ø±ÙˆØ²</h6>
      <div class="row g-2">
        <div class="col-md-3">
          <span class="fw-bold">ØªØ§Ø±ÛŒØ® Ú©Ø§Ù…Ù„:</span>
          <span id="todayFull">-</span>
        </div>
        <div class="col-md-3">
          <span class="fw-bold">Ø±ÙˆØ²:</span>
          <span id="todayDay">-</span>
        </div>
        <div class="col-md-3">
          <span class="fw-bold">Ù…Ø§Ù‡:</span>
          <span id="todayMonth">-</span>
        </div>
        <div class="col-md-3">
          <span class="fw-bold">Ø±ÙˆØ² Ù‡ÙØªÙ‡:</span>
          <span id="todayWeekday">-</span>
        </div>
      </div>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-bordered table-striped table-hover text-center align-middle">
      <thead class="table-primary">
        <tr>
          <th style="width:30%;">Ø¹Ù†ÙˆØ§Ù†</th>
          <th>Ø±ÙˆØ² Ø§ÙˆÙ„</th>
          <th>Ø±ÙˆØ² Ø¯ÙˆÙ…</th>
          <th>Ø±ÙˆØ² Ù‡ÙØªÙ…</th>
          <th>Ù…Ø§Ù‡</th>
          <th>Ø³Ø§Ù„</th>
        </tr>
      </thead>
      <tbody>
        {% for r in reminders %}
        <tr>
          <td style="max-width:200px;">
            {% if r.id %}
              <a href="{% url 'reminder:remind_detail' r.id %}" class="text-decoration-none text-dark" title="{{ r.title }}">
                <div class="text-truncate" style="max-width: 200px;">{{ r.title }}</div>
              </a>
            {% else %}
              <div class="text-truncate" style="max-width: 200px;" title="{{ r.title }}">{{ r.title }}</div>
            {% endif %}
          </td>

          <!-- ÙÙ‚Ø· Ø´Ù…Ø³ÛŒ -->
          <td class="jalali-date {% if r.one %}table-success{% endif %}">{{ r.one_date|date:'Y-m-d' }}</td>
          <td class="jalali-date {% if r.two %}table-success{% endif %}">{{ r.two_date|date:'Y-m-d' }}</td>
          <td class="jalali-date {% if r.seven %}table-success{% endif %}">{{ r.seven_date|date:'Y-m-d' }}</td>
          <td class="jalali-date {% if r.month %}table-success{% endif %}">{{ r.month_date|date:'Y-m-d' }}</td>
          <td class="jalali-date {% if r.year %}table-success{% endif %}">{{ r.year_date|date:'Y-m-d' }}</td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="6" class="text-center text-muted">Ù‡ÛŒÚ† ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
// ---------- ØªØ¨Ø¯ÛŒÙ„ Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ø¨Ù‡ Ø´Ù…Ø³ÛŒ ----------
function gregorianToJalali(gy, gm, gd) {
    const g_d_m = [0,31,59,90,120,151,181,212,243,273,304,334];
    let jy;
    if (gy > 1600) { jy = 979; gy -= 1600; }
    else { jy = 0; gy -= 621; }
    let gy2 = (gm > 2) ? (gy + 1) : gy;
    let days = 365*gy + Math.floor((gy2+3)/4) - Math.floor((gy2+99)/100) + Math.floor((gy2+399)/400) - 80 + gd + g_d_m[gm-1];
    jy += 33*Math.floor(days/12053);
    days %= 12053;
    jy += 4*Math.floor(days/1461);
    days %= 1461;
    if(days > 365) { jy += Math.floor((days-1)/365); days=(days-1)%365; }
    let jm = (days<186)?1+Math.floor(days/31):7+Math.floor((days-186)/30);
    let jd = 1+((days<186)?(days%31):((days-186)%30));
    return { jy,jm,jd };
}

// ---------- Ù¾Ø± Ú©Ø±Ø¯Ù† Ø¬Ø¯ÙˆÙ„ ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ ----------
document.addEventListener("DOMContentLoaded", function(){
    // Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø³Ù„ÙˆÙ„â€ŒÙ‡Ø§ÛŒ ØªØ§Ø±ÛŒØ®
    const cells = document.querySelectorAll('.jalali-date');
    cells.forEach(cell => {
        const dateParts = cell.textContent.trim().split('-');
        if(dateParts.length===3){
            const gy = parseInt(dateParts[0],10);
            const gm = parseInt(dateParts[1],10);
            const gd = parseInt(dateParts[2],10);
            const sh = gregorianToJalali(gy, gm, gd);
            const jm = sh.jm.toString().padStart(2,'0');
            const jd = sh.jd.toString().padStart(2,'0');
            cell.textContent = `${sh.jy}/${jm}/${jd}`;
        }
    });

    // ---------- ØªØ§Ø±ÛŒØ® Ø§Ù…Ø±ÙˆØ² ----------
    const today = new Date();
    const shToday = gregorianToJalali(today.getFullYear(), today.getMonth()+1, today.getDate());
    const jm = shToday.jm.toString().padStart(2,'0');
    const jd = shToday.jd.toString().padStart(2,'0');

    document.getElementById('todayFull').textContent = `${shToday.jy}/${jm}/${jd}`;
    document.getElementById('todayDay').textContent = jd;
    document.getElementById('todayMonth').textContent = jm;

    // Ø±ÙˆØ² Ù‡ÙØªÙ‡ Ø´Ù…Ø³ÛŒ (ÙØ§Ø±Ø³ÛŒ)
    const weekdays = ['ÛŒÚ©Ø´Ù†Ø¨Ù‡','Ø¯ÙˆØ´Ù†Ø¨Ù‡','Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡','Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡','Ù¾Ù†Ø¬â€ŒØ´Ù†Ø¨Ù‡','Ø¬Ù…Ø¹Ù‡','Ø´Ù†Ø¨Ù‡'];
    const weekdayIndex = today.getDay(); // 0 = ÛŒÚ©Ø´Ù†Ø¨Ù‡
    document.getElementById('todayWeekday').textContent = weekdays[weekdayIndex];
});
</script>
{% endblock %}
